on:
  push:
  pull_request:
jobs:
  test_mingw_on_windows:
    name: 'Test mingw on Windows'
    if: ${{ github.ref != 'refs/heads/ci-more' }}
    strategy:
      matrix:
        shared: ['ON', 'OFF']
        config: ['Release']
    runs-on: 'windows-latest'
    steps:
      - name: 'Checkout repo'
        uses: actions/checkout@v2
      - name: 'CMake configure'
        run: |
          mkdir build
          cd build
          cmake .. -DBUILD_SHARED_LIBS=${{ matrix.shared }} -DCMAKE_BUILD_TYPE=${{ matrix.config }} `
              -DFLATCC_INSTALL=ON -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/prefix" `
              -G "MinGW Makefiles"
          # -DCMAKE_C_FLAGS="-Wno-pedantic-ms-format" -DCMAKE_CXX_FLAGS="-Wno-pedantic-ms-format"
      - name: 'CMake build'
        run: |
          cmake --build build --parallel
      - name: 'CTest'
        run: |
          cd build
          ctest -V -C ${{ matrix.config }}
      - name: 'Install'
        run: |
          cmake --build build --target install
      - name: 'Test installed flatcc prefix'
        run: |
          $env:Path += ";${{ github.workspace }}/prefix/bin"
          mkdir user && cd user
          cmake "${{ github.workspace }}/test/install_test" `
              -DCMAKE_PREFIX_PATH="${{ github.workspace }}/prefix" -G "MinGW Makefiles"
          cmake --build .
          ctest .
